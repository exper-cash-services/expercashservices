# Dockerfile
# Ù†Ø¸Ø§Ù… EXPER CASH SERVICES - Ø¥Ø¹Ø¯Ø§Ø¯ Docker Ø§Ù„ÙƒØ§Ù…Ù„

# === Multi-stage build for optimization ===
FROM node:18-alpine AS base

# Ø¥Ø¶Ø§ÙØ© metadata Ù„Ù„ØµÙˆØ±Ø©
LABEL maintainer="EXPER CASH SERVICES <contact@expercash.ma>"
LABEL version="2.1.0"
LABEL description="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"
LABEL org.opencontainers.image.title="EXPER CASH SERVICES"
LABEL org.opencontainers.image.description="Advanced Financial Operations Management System"
LABEL org.opencontainers.image.version="2.1.0"
LABEL org.opencontainers.image.created="2024-01-25"
LABEL org.opencontainers.image.revision="main"
LABEL org.opencontainers.image.vendor="EXPER CASH SERVICES SARL"

# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
ARG NODE_ENV=production
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=2.1.0

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV NODE_ENV=${NODE_ENV}
ENV PORT=3000
ENV APP_DIR=/app
ENV USER_NAME=nodejs
ENV USER_UID=1001
ENV USER_GID=1001

# Ø¥Ø¶Ø§ÙØ© labels Ø¥Ø¶Ø§ÙÙŠØ©
LABEL org.opencontainers.image.created=${BUILD_DATE}
LABEL org.opencontainers.image.revision=${VCS_REF}

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root Ù„Ù„Ø£Ù…Ø§Ù†
RUN addgroup -g ${USER_GID} -S ${USER_NAME} && \
    adduser -S ${USER_NAME} -u ${USER_UID} -G ${USER_NAME}

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
RUN apk add --no-cache \
    dumb-init \
    tzdata \
    curl \
    bash \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
ENV TZ=Africa/Casablanca
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
WORKDIR $APP_DIR

# === Ù…Ø±Ø­Ù„Ø© ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ===
FROM base AS dependencies

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª package Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Docker cache
COPY package*.json ./

# ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¥Ù†ØªØ§Ø¬
RUN npm ci --only=production && \
    npm cache clean --force && \
    rm -rf /tmp/*

# === Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø± ===
FROM base AS builder

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
COPY package*.json ./

# ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª (including devDependencies)
RUN npm ci --include=dev

# Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ
COPY . .

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙØ­Øµ (Ø¥Ø°Ø§ ØªÙˆÙØ±Øª)
RUN if [ -f "package.json" ] && npm run test --if-present; then \
        echo "Tests passed"; \
    else \
        echo "No tests found or tests disabled"; \
    fi

# ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯ (Ø¥Ø°Ø§ ØªÙˆÙØ±)
RUN if [ -f "package.json" ] && npm run lint --if-present; then \
        echo "Linting passed"; \
    else \
        echo "No linting configured"; \
    fi

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
RUN mkdir -p docs && \
    echo "# EXPER CASH SERVICES API Documentation" > docs/README.md && \
    echo "Generated on $(date)" >> docs/README.md

# === Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ===
FROM base AS production

# ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¥Ù†ØªØ§Ø¬
RUN apk add --no-cache \
    mongodb-tools \
    redis \
    && rm -rf /var/cache/apk/*

# Ù†Ø³Ø® Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù…Ù† Ù…Ø±Ø­Ù„Ø© dependencies
COPY --from=dependencies --chown=${USER_NAME}:${USER_NAME} $APP_DIR/node_modules ./node_modules

# Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ
COPY --chown=${USER_NAME}:${USER_NAME} . .

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
RUN mkdir -p \
    logs \
    uploads \
    backups \
    reports \
    temp \
    data \
    public \
    config \
    scripts \
    && chown -R ${USER_NAME}:${USER_NAME} \
        logs \
        uploads \
        backups \
        reports \
        temp \
        data \
        public \
        config \
        scripts

# Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
RUN rm -rf \
    .git \
    .gitignore \
    .dockerignore \
    README.md \
    docker-compose.yml \
    Dockerfile* \
    tests/ \
    .env.example \
    *.md \
    coverage/ \
    .nyc_output \
    .eslintrc.js \
    jest.config.js

# ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
RUN chmod +x scripts/*.sh 2>/dev/null || true && \
    chmod 755 $APP_DIR && \
    find $APP_DIR -type d -exec chmod 755 {} \; && \
    find $APP_DIR -type f -exec chmod 644 {} \;

# ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø¥Ø°Ø§ ØªÙˆÙØ±Øª Ø§Ù„Ø£Ø¯ÙˆØ§Øª)
RUN if command -v npm >/dev/null 2>&1; then \
        npm audit --audit-level moderate || echo "Security audit completed with warnings"; \
    fi

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
RUN echo "{ \
    \"build_date\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \
    \"version\": \"${VERSION}\", \
    \"node_version\": \"$(node --version)\", \
    \"npm_version\": \"$(npm --version)\", \
    \"os\": \"$(uname -s)\", \
    \"arch\": \"$(uname -m)\", \
    \"user\": \"${USER_NAME}\" \
}" > build-info.json

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER ${USER_NAME}

# ÙƒØ´Ù Ø§Ù„Ù…Ù†ÙØ°
EXPOSE $PORT

# Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
ENV NODE_OPTIONS="--max-old-space-size=1024"
ENV UV_THREADPOOL_SIZE=4

# ÙØ­Øµ ØµØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:$PORT/api/health || exit 1

# Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¯Ø®ÙˆÙ„ Ù…Ø®ØµØµØ©
COPY --chown=${USER_NAME}:${USER_NAME} docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ dumb-init Ù„Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
ENTRYPOINT ["dumb-init", "--", "/usr/local/bin/docker-entrypoint.sh"]

# Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
CMD ["node", "server.js"]

# === Dockerfile.backup (Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©) ===
FROM mongo:6.0 AS backup

# Ø¥Ø¶Ø§ÙØ© metadata
LABEL maintainer="EXPER CASH SERVICES <contact@expercash.ma>"
LABEL description="Backup service for EXPER CASH SERVICES"
LABEL version="1.0.0"

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
RUN apt-get update && apt-get install -y \
    cron \
    curl \
    gzip \
    tar \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
RUN useradd -m -s /bin/bash backup

# ØªØ¹ÙŠÙŠÙ† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
WORKDIR /app

# Ù†Ø³Ø® Ù†ØµÙˆØµ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
COPY scripts/backup.sh /usr/local/bin/backup.sh
COPY scripts/restore.sh /usr/local/bin/restore.sh
COPY scripts/backup-cron.sh /usr/local/bin/backup-cron.sh

# ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
RUN chmod +x /usr/local/bin/backup.sh && \
    chmod +x /usr/local/bin/restore.sh && \
    chmod +x /usr/local/bin/backup-cron.sh

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
RUN mkdir -p /app/backups && \
    chown -R backup:backup /app

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV BACKUP_DIR=/app/backups
ENV CRON_SCHEDULE="0 2 * * *"

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… backup
USER backup

# ÙƒØ´Ù Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø³Ø®
VOLUME ["/app/backups"]

# Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
CMD ["/usr/local/bin/backup-cron.sh"]

# === docker-entrypoint.sh script ===
FROM scratch AS entrypoint-script
COPY <<'EOF' /docker-entrypoint.sh
#!/bin/bash
set -e

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
print_info "ğŸš€ Starting EXPER CASH SERVICES..."
print_info "ğŸ“¦ Container: $(hostname)"
print_info "ğŸ‘¤ User: $(whoami)"
print_info "ğŸ• Time: $(date)"
print_info "ğŸŒ Timezone: $TZ"
print_info "âš™ï¸  Node.js: $(node --version)"
print_info "ğŸ“¦ npm: $(npm --version)"

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
if [ -z "$MONGODB_URI" ]; then
    print_warning "MONGODB_URI not set, using default"
    export MONGODB_URI="mongodb://localhost:27017/exper_cash_db"
fi

if [ -z "$JWT_SECRET" ]; then
    print_warning "JWT_SECRET not set, generating random secret"
    export JWT_SECRET=$(openssl rand -base64 32)
fi

# Ø§Ù†ØªØ¸Ø§Ø± Ø®Ø¯Ù…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if [ "$NODE_ENV" != "development" ]; then
    print_info "â³ Waiting for database services..."
    
    # Ø§Ù†ØªØ¸Ø§Ø± MongoDB
    until mongosh --host "${MONGODB_URI}" --eval "db.adminCommand('ping')" >/dev/null 2>&1; do
        print_info "â³ Waiting for MongoDB..."
        sleep 2
    done
    print_success "âœ… MongoDB is ready"
    
    # Ø§Ù†ØªØ¸Ø§Ø± Redis (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ø±ÙÙ‘ÙØ§Ù‹)
    if [ ! -z "$REDIS_URL" ]; then
        until redis-cli -u "$REDIS_URL" ping >/dev/null 2>&1; do
            print_info "â³ Waiting for Redis..."
            sleep 2
        done
        print_success "âœ… Redis is ready"
    fi
fi

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
print_info "ğŸ“ Creating required directories..."
mkdir -p logs uploads backups reports temp data

# ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
print_info "ğŸ” Checking permissions..."
if [ ! -w "logs" ]; then
    print_error "âŒ Cannot write to logs directory"
    exit 1
fi

if [ ! -w "uploads" ]; then
    print_error "âŒ Cannot write to uploads directory"
    exit 1
fi

print_success "âœ… All permissions are correct"

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‡Ø¬Ø±Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©)
if [ -f "scripts/migrate.js" ] && [ "$NODE_ENV" = "production" ]; then
    print_info "ğŸ”„ Running database migrations..."
    node scripts/migrate.js || print_warning "Migration completed with warnings"
fi

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© (ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±)
if [ "$NODE_ENV" = "development" ] && [ -f "scripts/seed.js" ]; then
    print_info "ğŸŒ± Seeding database with sample data..."
    node scripts/seed.js || print_warning "Seeding completed with warnings"
fi

# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
print_success "ğŸ‰ EXPER CASH SERVICES is ready!"
print_info "ğŸŒ Application will be available on port $PORT"
print_info "ğŸ“Š Health check: http://localhost:$PORT/api/health"

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù…Ø±Ø³Ù„
exec "$@"
EOF

# === Dockerfile Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ† ===
FROM production AS final

# Ù†Ø³Ø® Ù†Øµ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
COPY --from=entrypoint-script --chown=${USER_NAME}:${USER_NAME} /docker-entrypoint.sh /usr/local/bin/

# Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù ØªÙƒÙˆÙŠÙ† nginx (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ø§Ù‹)
FROM nginx:alpine AS nginx-config
COPY <<'EOF' /etc/nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    gzip on;
    gzip_vary on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private must-revalidate;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/x-javascript
        application/xml+rss
        application/javascript
        application/json;
    
    # ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
    server_tokens off;
    
    # ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    include /etc/nginx/conf.d/*.conf;
}
EOF

# Ø¥Ø¶Ø§ÙØ© ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
COPY <<'EOF' /etc/nginx/conf.d/default.conf
upstream app {
    server app:3000;
    keepalive 32;
}

server {
    listen 80;
    server_name localhost;
    
    # ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # proxy Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    location / {
        proxy_pass http://app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        proxy_temp_file_write_size 8k;
        
        # Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ©
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Ù…Ù„ÙØ§Øª Ø«Ø§Ø¨ØªØ©
    location /static/ {
        alias /var/www/html/;
        expires 1M;
        add_header Cache-Control "public, immutable";
    }
    
    # ÙØ­Øµ Ø§Ù„ØµØ­Ø©
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}
EOF

# === Ù…Ù„Ù .dockerignore ===
FROM scratch AS dockerignore
COPY <<'EOF' /.dockerignore
# Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±
node_modules
npm-debug.log*
.git
.gitignore
README.md
.env
.env.local
.env.*.local

# Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
coverage/
.nyc_output
.cache
*.log

# Ù…Ù„ÙØ§Øª IDE
.vscode/
.idea/
*.swp
*.swo

# Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
backups/
*.backup

# Ù…Ù„ÙØ§Øª Ù…Ø¤Ù‚ØªØ©
temp/
tmp/
*.tmp

# Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
.DS_Store
Thumbs.db

# Ù…Ù„ÙØ§Øª Docker
Dockerfile*
docker-compose*.yml
.dockerignore

# Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚
docs/
*.md

# Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
test/
tests/
spec/
jest.config.js
.eslintrc.js

# Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
data/
uploads/
logs/
reports/
EOF
